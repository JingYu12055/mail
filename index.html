<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Gmail Viewer</title>
</head>
<body>
  <h2>ğŸ“§ Gmail Viewer</h2>
  <button id="login">ç™»å…¥ Google</button>
  <div id="emails"></div>

  <script>
    const CLIENT_ID = '158053251905-v472iagbsfl2m9jnv35c7j43tmgqf35i.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';

    function startApp() {
      gapi.load('client:auth2', async () => {
        await gapi.client.init({
          clientId: CLIENT_ID,
          scope: SCOPES,
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest']
        });

        document.getElementById('login').addEventListener('click', async () => {
          const auth = gapi.auth2.getAuthInstance();
          try {
            await auth.signIn();
            const token = auth.currentUser.get().getAuthResponse().access_token;
            console.log("Access Token:", token);
            await listEmails(token);
          } catch (err) {
            console.error('ç™»å…¥éŒ¯èª¤', err);
            alert('ç™»å…¥å¤±æ•—');
          }
        });
      });
    }

    async function listEmails(token) {
      try {
        const res = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages', {
          headers: { Authorization: 'Bearer ' + token }
        });
        const data = await res.json();
        console.log('Response:', data);

        if (data.error) {
          alert('Gmail API éŒ¯èª¤ï¼š' + data.error.message);
          return;
        }

        const div = document.getElementById('emails');
        div.innerHTML = '<h3>æœ€è¿‘éƒµä»¶ï¼š</h3>';
        for (let m of (data.messages || []).slice(0, 5)) {
          const msgRes = await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${m.id}`, {
            headers: { Authorization: 'Bearer ' + token }
          });
          const msgData = await msgRes.json();
          const subject = msgData.payload.headers.find(h => h.name === 'Subject')?.value || '(ç„¡ä¸»é¡Œ)';
          div.innerHTML += `<p>${subject}</p>`;
        }
      } catch (err) {
        console.error('Fetch éŒ¯èª¤', err);
      }
    }

    // ç­‰ body å‡ºç¾å¾Œå†å‹•æ…‹åŠ è¼‰ Google API
    window.onload = function () {
      const script = document.createElement('script');
      script.src = 'https://apis.google.com/js/api.js';
      script.onload = startApp;
      document.body.appendChild(script);
    };
  </script>
</body>
</html>
