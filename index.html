<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Gmail Viewer (New GIS)</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h2>📧 Gmail Viewer</h2>
  <div id="g_id_signin"></div>
  <div id="emails"></div>

  <script>
    const CLIENT_ID = '158053251905-v472iagbsfl2m9jnv35c7j43tmgqf35i.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';

    let accessToken = null;

    // 初始化 Google 登入按鈕
    window.onload = function () {
      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleCredentialResponse
      });

      // 顯示登入按鈕
      google.accounts.id.renderButton(
        document.getElementById("g_id_signin"),
        { theme: "outline", size: "large", text: "signin_with", shape: "rectangular" }
      );
    };

    async function handleCredentialResponse(response) {
      // 取得 OAuth 2.0 Token
      const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          listEmails();
        },
      });
      tokenClient.requestAccessToken();
    }

    async function listEmails() {
      if (!accessToken) return alert("尚未登入");
      const res = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages', {
        headers: { Authorization: 'Bearer ' + accessToken }
      });
      const data = await res.json();
      console.log("Response:", data);

      const div = document.getElementById('emails');
      div.innerHTML = '<h3>最近郵件：</h3>';

      if (!data.messages) {
        div.innerHTML += `<p>沒有找到郵件或權限不足。</p>`;
        return;
      }

      for (let m of data.messages.slice(0, 5)) {
        const msgRes = await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${m.id}`, {
          headers: { Authorization: 'Bearer ' + accessToken }
        });
        const msgData = await msgRes.json();
        const subject = msgData.payload.headers.find(h => h.name === 'Subject')?.value || '(無主題)';
        div.innerHTML += `<p>${subject}</p>`;
      }
    }
  </script>
</body>
</html>
