<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>My Gmail Viewer</title>
</head>
<body>
  <h2>📧 Gmail Viewer</h2>
  <button id="login">登入 Google</button>
  <div id="emails"></div>

  <script>
    const CLIENT_ID = '158053251905-v472iagbsfl2m9jnv35c7j43tmgqf35i.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';

    // 載入 Google API
    function loadGapi() {
      const script = document.createElement('script');
      script.src = 'https://apis.google.com/js/api.js';
      script.onload = initGapi;
      document.body.appendChild(script);
    }

    function initGapi() {
      gapi.load('client:auth2', async () => {
        await gapi.client.init({
          apiKey: 'AIzaSyD9A4YhuBUa4C0H-qgIBp7xwhJF46HVEqo', // 不一定需要
          clientId: CLIENT_ID,
          scope: SCOPES,
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest']
        });
        document.getElementById('login').onclick = handleLogin;
      });
    }

    async function handleLogin() {
      const GoogleAuth = gapi.auth2.getAuthInstance();
      await GoogleAuth.signIn();
      const user = GoogleAuth.currentUser.get();
      const token = user.getAuthResponse().access_token;
      fetchEmails(token);
    }

    async function fetchEmails(token) {
      const res = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages', {
        headers: { Authorization: 'Bearer ' + token }
      });
      const data = await res.json();
      const emails = document.getElementById('emails');
      emails.innerHTML = '<h3>最近郵件：</h3>';

      for (let msg of data.messages.slice(0, 5)) {
        const msgRes = await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${msg.id}`, {
          headers: { Authorization: 'Bearer ' + token }
        });
        const msgData = await msgRes.json();
        const subject = msgData.payload.headers.find(h => h.name === 'Subject')?.value || '(無主題)';
        emails.innerHTML += `<p>${subject}</p>`;
      }
    }

    loadGapi();
  </script>
</body>
</html>
